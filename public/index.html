<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Real-Time Communication</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

</head>

<body>
  <div class="auth-container">
    <div class="auth-card">
      <h1>Welcome Back</h1>
      <p>Sign in to start communicating</p>

      <div id="error-message" class="error-message" style="display: none;"></div>

      <!-- Login Form -->
      <form id="login-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="you@example.com" required>
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="••••••••" required>
        </div>

        <button type="submit" class="btn">Sign In</button>
      </form>

      <!-- Register Form (Hidden by default) -->
      <form id="register-form" style="display: none;">
        <div class="form-group">
          <label for="register-email">Email Address</label>
          <input type="email" id="register-email" placeholder="you@example.com" required>
        </div>

        <div class="form-group">
          <label for="register-password">Password</label>
          <input type="password" id="register-password" placeholder="••••••••" required>
        </div>

        <div class="form-group">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" placeholder="••••••••" required>
        </div>

        <button type="submit" class="btn">Create Account</button>
      </form>

      <div class="toggle-auth">
        <span id="toggle-text">Don't have an account? <a id="toggle-link">Sign up</a></span>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- CryptoJS for encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- App Scripts -->
  <script src="/js/firebaseConfig.js"></script>
  <script src="/js/encryption.js"></script>
  <script src="/js/auth.js"></script>

  <script>
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const toggleLink = document.getElementById('toggle-link');
    const toggleText = document.getElementById('toggle-text');
    const errorMessage = document.getElementById('error-message');

    let isLoginMode = true;

    // Toggle between login and register
    toggleLink.addEventListener('click', () => {
      isLoginMode = !isLoginMode;

      if (isLoginMode) {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        toggleText.innerHTML = 'Don\'t have an account? <a id="toggle-link">Sign up</a>';
        document.querySelector('h1').textContent = 'Welcome Back';
        document.querySelector('p').textContent = 'Sign in to start communicating';
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        toggleText.innerHTML = 'Already have an account? <a id="toggle-link">Sign in</a>';
        document.querySelector('h1').textContent = 'Create Account';
        document.querySelector('p').textContent = 'Join the communication platform';
      }

      // Re-attach event listener to new toggle link
      document.getElementById('toggle-link').addEventListener('click', arguments.callee);
      errorMessage.style.display = 'none';
    });

    // Login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const result = await AuthManager.login(email, password);

      if (result.success) {
        window.location.href = '/dashboard.html';
      } else {
        errorMessage.textContent = result.error;
        errorMessage.style.display = 'block';
      }
    });

    // Register form submission
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (password !== confirmPassword) {
        errorMessage.textContent = 'Passwords do not match';
        errorMessage.style.display = 'block';
        return;
      }

      if (password.length < 6) {
        errorMessage.textContent = 'Password must be at least 6 characters';
        errorMessage.style.display = 'block';
        return;
      }

      const result = await AuthManager.register(email, password);

      if (result.success) {
        window.location.href = '/dashboard.html';
      } else {
        errorMessage.textContent = result.error;
        errorMessage.style.display = 'block';
      }
    });

    // Check if already logged in
    if (AuthManager.isAuthenticated()) {
      window.location.href = '/dashboard.html';
    }
  </script>
</body>

</html>